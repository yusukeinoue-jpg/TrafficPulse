<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrafficPulse - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äº¤é€šæƒ…å ±</title>

    <!-- Leaflet CSS (Free & Open Source) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #12171f;
            --bg-card: rgba(18, 23, 31, 0.95);
            --border-color: #1e2938;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #484f58;
            --cyan: #00d9ff;
            --cyan-glow: rgba(0, 217, 255, 0.3);
            --magenta: #ff00aa;
            --magenta-glow: rgba(255, 0, 170, 0.3);
            --green: #00ff88;
            --yellow: #ffcc00;
            --orange: #ff8800;
            --red: #ff3366;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        .leaflet-tile-pane {
            filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(1.1);
        }

        .leaflet-control-attribution {
            background: var(--bg-card) !important;
            color: var(--text-muted) !important;
            font-size: 10px !important;
        }

        .leaflet-control-attribution a {
            color: var(--cyan) !important;
        }

        .leaflet-control-zoom a {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--bg-secondary) !important;
            color: var(--cyan) !important;
        }

        .header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 24px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 16px 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--cyan), var(--magenta));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 20px;
            background: linear-gradient(90deg, var(--cyan), var(--magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 51, 102, 0.15);
            border: 1px solid var(--red);
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--red);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-badge.demo {
            background: rgba(255, 204, 0, 0.15);
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--red);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .live-badge.demo .live-dot {
            background: var(--yellow);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .current-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .data-source-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-source-toggle:hover {
            border-color: var(--cyan);
        }

        .data-source-toggle input {
            display: none;
        }

        .toggle-slider {
            width: 36px;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: all 0.2s;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .data-source-toggle input:checked + .toggle-slider {
            background: var(--cyan);
        }

        .data-source-toggle input:checked + .toggle-slider::after {
            left: 18px;
            background: var(--bg-primary);
        }

        .toggle-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .side-panel {
            position: fixed;
            top: 80px;
            left: 16px;
            bottom: 16px;
            width: 340px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .filter-tabs {
            display: flex;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .filter-tab {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .filter-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .filter-tab.active {
            background: var(--bg-secondary);
            color: var(--cyan);
            box-shadow: 0 0 20px var(--cyan-glow);
        }

        .filter-tab .count {
            background: var(--border-color);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        .filter-tab.active .count {
            background: var(--cyan);
            color: var(--bg-primary);
        }

        .cards-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 4px;
        }

        .cards-container::-webkit-scrollbar {
            width: 4px;
        }

        .cards-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .cards-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .info-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .info-card:hover {
            border-color: var(--cyan);
            transform: translateX(4px);
            box-shadow: 0 0 20px var(--cyan-glow);
        }

        .info-card.train {
            border-left: 3px solid var(--line-color, var(--cyan));
        }

        .info-card.regulation {
            border-left: 3px solid var(--magenta);
        }

        .info-card.road {
            border-left: 3px solid var(--yellow);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
        }

        .card-status {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .status-suspended { background: rgba(255, 51, 102, 0.2); color: var(--red); }
        .status-delayed { background: rgba(255, 136, 0, 0.2); color: var(--orange); }
        .status-minor { background: rgba(255, 204, 0, 0.2); color: var(--yellow); }
        .status-normal { background: rgba(0, 255, 136, 0.2); color: var(--green); }
        .status-active { background: rgba(255, 0, 170, 0.2); color: var(--magenta); }

        .card-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .card-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-panel {
            position: fixed;
            top: 80px;
            right: 16px;
            width: 280px;
            z-index: 1000;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .stats-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.yellow { color: var(--yellow); }
        .stat-value.orange { color: var(--orange); }
        .stat-value.red { color: var(--red); }
        .stat-value.cyan { color: var(--cyan); }
        .stat-value.magenta { color: var(--magenta); }

        .legend {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .legend-title {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        .legend-color.suspended { background: var(--red); }
        .legend-color.delayed { background: var(--orange); }
        .legend-color.minor { background: var(--yellow); }
        .legend-color.normal { background: var(--green); }
        .legend-color.regulation { background: var(--magenta); }

        .leaflet-popup-content-wrapper {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
        }

        .leaflet-popup-content {
            margin: 16px !important;
            color: var(--text-primary) !important;
            font-family: 'Noto Sans JP', sans-serif !important;
        }

        .leaflet-popup-tip {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
        }

        .popup-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .popup-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .popup-info {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* API Setup Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--cyan);
        }

        .modal h3 {
            font-size: 14px;
            margin: 20px 0 8px;
            color: var(--text-primary);
        }

        .modal p, .modal li {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .modal ol {
            padding-left: 20px;
        }

        .modal a {
            color: var(--cyan);
            text-decoration: none;
        }

        .modal a:hover {
            text-decoration: underline;
        }

        .modal code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--magenta);
        }

        .modal input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            margin: 12px 0;
        }

        .modal input[type="text"]:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: var(--cyan);
            color: var(--bg-primary);
        }

        .modal-btn.primary:hover {
            background: #00c4e6;
        }

        .modal-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .modal-btn.secondary:hover {
            border-color: var(--text-secondary);
        }

        .loading-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-indicator.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .side-panel {
                width: calc(100% - 32px);
                bottom: auto;
                max-height: 40vh;
            }

            .stats-panel {
                top: auto;
                bottom: 16px;
                right: 16px;
                left: 16px;
                width: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .header {
                flex-wrap: wrap;
                justify-content: center;
            }

            .data-source-toggle {
                order: 10;
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸš¦</div>
            <span class="logo-text">TrafficPulse</span>
        </div>
        <div class="live-badge demo" id="liveBadge">
            <span class="live-dot"></span>
            <span id="dataSourceLabel">DEMO</span>
        </div>
        <div class="current-time" id="currentTime">--:--:--</div>
        <label class="data-source-toggle" id="dataToggle">
            <input type="checkbox" id="useRealData">
            <span class="toggle-slider"></span>
            <span class="toggle-label">ODPT API</span>
        </label>
    </header>

    <!-- Side Panel -->
    <div class="side-panel">
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">
                ã™ã¹ã¦ <span class="count" id="countAll">0</span>
            </button>
            <button class="filter-tab" data-filter="train">
                ğŸšƒ é›»è»Š <span class="count" id="countTrain">0</span>
            </button>
            <button class="filter-tab" data-filter="regulation">
                ğŸš§ è¦åˆ¶ <span class="count" id="countRegulation">0</span>
            </button>
            <button class="filter-tab" data-filter="road">
                ğŸš— é“è·¯ <span class="count" id="countRoad">0</span>
            </button>
        </div>

        <div class="cards-container" id="cardsContainer"></div>
    </div>

    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="stats-title">é‹è¡ŒçŠ¶æ³ã‚µãƒãƒªãƒ¼</div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">é…å»¶è·¯ç·š</div>
                <div class="stat-value orange" id="delayedLines">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">é‹è»¢è¦‹åˆ</div>
                <div class="stat-value red" id="suspendedLines">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">äº¤é€šè¦åˆ¶</div>
                <div class="stat-value magenta" id="activeRegulations">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ¸‹æ»ç®‡æ‰€</div>
                <div class="stat-value yellow" id="congestionPoints">0</div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">å‡¡ä¾‹</div>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="legend-color suspended"></span>
                    é‹è»¢è¦‹åˆã‚ã›
                </div>
                <div class="legend-item">
                    <span class="legend-color delayed"></span>
                    15åˆ†ä»¥ä¸Šé…å»¶
                </div>
                <div class="legend-item">
                    <span class="legend-color minor"></span>
                    15åˆ†æœªæº€é…å»¶
                </div>
                <div class="legend-item">
                    <span class="legend-color normal"></span>
                    å¹³å¸¸é‹è»¢
                </div>
                <div class="legend-item">
                    <span class="legend-color regulation"></span>
                    äº¤é€šè¦åˆ¶
                </div>
            </div>
        </div>
    </div>

    <!-- API Setup Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <h2>ğŸ”‘ ODPT API è¨­å®š</h2>

            <h3>Step 1: é–‹ç™ºè€…ç™»éŒ²ï¼ˆç„¡æ–™ï¼‰</h3>
            <ol>
                <li><a href="https://developer-tokyochallenge.odpt.org/" target="_blank">ODPTé–‹ç™ºè€…ã‚µã‚¤ãƒˆ</a>ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                <li>ã€Œæ–°è¦ç™»éŒ²ã€ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</li>
                <li>ç™»éŒ²å®Œäº†ã¾ã§ç´„2å–¶æ¥­æ—¥å¾…æ©Ÿ</li>
            </ol>

            <h3>Step 2: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—</h3>
            <ol>
                <li>é–‹ç™ºè€…ã‚µã‚¤ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³</li>
                <li>ã€Œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ç™ºè¡Œ</li>
                <li>ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼</li>
            </ol>

            <h3>Step 3: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›</h3>
            <p>å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆconsumerKeyï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
            <input type="text" id="apiKeyInput" placeholder="acl:consumerKey=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

            <p style="margin-top: 12px; font-size: 11px; color: var(--text-muted);">
                â€» ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼‰
            </p>

            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶šã‘ã‚‹</button>
                <button class="modal-btn primary" onclick="saveApiKey()">ä¿å­˜ã—ã¦æ¥ç¶š</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <span>ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</span>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ============================================
        // Configuration
        // ============================================

        const CONFIG = {
            ODPT_API_BASE: 'https://api.odpt.org/api/v4',
            REFRESH_INTERVAL: 60000, // 1 minute
            STORAGE_KEY: 'trafficpulse_api_key',
            DATA_BASE_URL: 'data/' // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        };

        // Railway line metadata (for visualization)
        const RAILWAY_META = {
            'odpt.Railway:TokyoMetro.Ginza': { name: 'éŠ€åº§ç·š', color: '#ff9500', coords: [[35.7110, 139.7966], [35.7034, 139.7714], [35.6813, 139.7660], [35.6684, 139.7587], [35.6580, 139.7016]] },
            'odpt.Railway:TokyoMetro.Marunouchi': { name: 'ä¸¸ãƒå†…ç·š', color: '#f62e36', coords: [[35.7281, 139.7103], [35.7069, 139.7517], [35.6813, 139.7660], [35.6684, 139.7587], [35.6553, 139.7494], [35.6459, 139.7386]] },
            'odpt.Railway:TokyoMetro.Hibiya': { name: 'æ—¥æ¯”è°·ç·š', color: '#b5b5ac', coords: [[35.7539, 139.8052], [35.7130, 139.7793], [35.6813, 139.7660], [35.6580, 139.7016], [35.6298, 139.7155]] },
            'odpt.Railway:TokyoMetro.Tozai': { name: 'æ±è¥¿ç·š', color: '#009bbf', coords: [[35.6745, 139.8145], [35.6813, 139.7660], [35.7034, 139.7508], [35.7110, 139.6243]] },
            'odpt.Railway:TokyoMetro.Chiyoda': { name: 'åƒä»£ç”°ç·š', color: '#00bb85', coords: [[35.7677, 139.8234], [35.7367, 139.7429], [35.6813, 139.7660], [35.6298, 139.7155]] },
            'odpt.Railway:TokyoMetro.Yurakucho': { name: 'æœ‰æ¥½ç”ºç·š', color: '#c1a470', coords: [[35.7551, 139.6995], [35.7281, 139.7103], [35.6813, 139.7660], [35.6459, 139.7101]] },
            'odpt.Railway:TokyoMetro.Hanzomon': { name: 'åŠè”µé–€ç·š', color: '#8f76d6', coords: [[35.7110, 139.8100], [35.6813, 139.7660], [35.6580, 139.7016], [35.6267, 139.6402]] },
            'odpt.Railway:TokyoMetro.Namboku': { name: 'å—åŒ—ç·š', color: '#00ac9b', coords: [[35.7815, 139.7348], [35.7281, 139.7103], [35.6813, 139.7660], [35.6337, 139.7406]] },
            'odpt.Railway:TokyoMetro.Fukutoshin': { name: 'å‰¯éƒ½å¿ƒç·š', color: '#9c5e31', coords: [[35.7551, 139.6995], [35.7281, 139.7103], [35.6917, 139.7003], [35.6580, 139.7016]] },
            'odpt.Railway:Toei.Asakusa': { name: 'éƒ½å–¶æµ…è‰ç·š', color: '#e85298', coords: [[35.7860, 139.8082], [35.7034, 139.7714], [35.6580, 139.7016], [35.5886, 139.7390]] },
            'odpt.Railway:Toei.Mita': { name: 'éƒ½å–¶ä¸‰ç”°ç·š', color: '#0079c2', coords: [[35.7816, 139.6836], [35.7281, 139.7103], [35.6580, 139.7016], [35.6298, 139.7155]] },
            'odpt.Railway:Toei.Shinjuku': { name: 'éƒ½å–¶æ–°å®¿ç·š', color: '#6cbb5a', coords: [[35.6896, 139.6998], [35.6917, 139.7600], [35.7034, 139.8370]] },
            'odpt.Railway:Toei.Oedo': { name: 'éƒ½å–¶å¤§æ±Ÿæˆ¸ç·š', color: '#b6007a', coords: [[35.7110, 139.7966], [35.6917, 139.7003], [35.6580, 139.7016], [35.6684, 139.7587], [35.7069, 139.7517]] }
        };

        // ============================================
        // Demo Data
        // ============================================

        const DEMO_TRAIN_LINES = [
            { id: 'yamanote', name: 'å±±æ‰‹ç·š', color: '#9acd32', status: 'delayed', delayMinutes: 8, description: 'äººèº«äº‹æ•…ã®å½±éŸ¿ã§ä¸€éƒ¨åŒºé–“ã§é…å»¶ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™', section: 'æ± è¢‹ã€œå¤§å¡šé–“', coordinates: [[35.7281, 139.7103], [35.7319, 139.7184], [35.7367, 139.7258], [35.7298, 139.7429], [35.7130, 139.7535], [35.6917, 139.7600], [35.6684, 139.7587], [35.6553, 139.7494], [35.6459, 139.7386], [35.6459, 139.7101], [35.6580, 139.7016], [35.6762, 139.6999], [35.6917, 139.7003], [35.7069, 139.7024], [35.7281, 139.7103]] },
            { id: 'chuo-rapid', name: 'ä¸­å¤®ç·šå¿«é€Ÿ', color: '#ff6600', status: 'suspended', delayMinutes: null, description: 'æ²¿ç·šç«ç½ã®ãŸã‚ä¸‰é·¹ã€œå›½åˆ†å¯ºé–“ã§é‹è»¢ã‚’è¦‹åˆã‚ã›ã¦ã„ã¾ã™', section: 'ä¸‰é·¹ã€œå›½åˆ†å¯ºé–“', coordinates: [[35.6813, 139.7660], [35.6809, 139.7364], [35.6658, 139.7093], [35.6639, 139.6844], [35.6996, 139.5814], [35.7010, 139.5446], [35.7022, 139.4809]] },
            { id: 'keio', name: 'äº¬ç‹ç·š', color: '#dd0077', status: 'minor', delayMinutes: 5, description: 'è»Šä¸¡ç‚¹æ¤œã®å½±éŸ¿ã§ãƒ€ã‚¤ãƒ¤ã«ä¹±ã‚ŒãŒå‡ºã¦ã„ã¾ã™', section: 'æ–°å®¿ã€œèª¿å¸ƒé–“', coordinates: [[35.6896, 139.6998], [35.6779, 139.6568], [35.6593, 139.5882], [35.6512, 139.5442]] },
            { id: 'tokyu-toyoko', name: 'æ±æ€¥æ±æ¨ªç·š', color: '#ee1155', status: 'normal', delayMinutes: 0, description: 'å¹³å¸¸ã©ãŠã‚Šé‹è»¢ã—ã¦ã„ã¾ã™', section: null, coordinates: [[35.6580, 139.7016], [35.6339, 139.6991], [35.6064, 139.6685], [35.5755, 139.6587], [35.5162, 139.6165]] },
            { id: 'metro-ginza', name: 'éŠ€åº§ç·š', color: '#ff9500', status: 'normal', delayMinutes: 0, description: 'å¹³å¸¸ã©ãŠã‚Šé‹è»¢ã—ã¦ã„ã¾ã™', section: null, coordinates: [[35.7110, 139.7966], [35.7034, 139.7714], [35.6813, 139.7660], [35.6684, 139.7587], [35.6580, 139.7016]] },
            { id: 'metro-marunouchi', name: 'ä¸¸ãƒå†…ç·š', color: '#f62e36', status: 'normal', delayMinutes: 0, description: 'å¹³å¸¸ã©ãŠã‚Šé‹è»¢ã—ã¦ã„ã¾ã™', section: null, coordinates: [[35.7281, 139.7103], [35.7069, 139.7517], [35.6813, 139.7660], [35.6684, 139.7587], [35.6553, 139.7494], [35.6459, 139.7386]] }
        ];

        const DEMO_REGULATIONS = [
            { id: 'reg1', type: 'marathon', name: 'æ±äº¬ãƒãƒ©ã‚½ãƒ³2024', description: 'äº¤é€šè¦åˆ¶: éƒ½åºã€œæ±äº¬é§…å‘¨è¾ºã®ä¸»è¦é“è·¯ãŒé€šè¡Œæ­¢ã‚', timeRange: '9:00ã€œ16:00', area: [[35.6896, 139.6920], [35.6896, 139.7680], [35.6750, 139.7680], [35.6750, 139.6920]], center: [35.6823, 139.7300] },
            { id: 'reg2', type: 'festival', name: 'ç¥ç”°ç¥­ ç¥è¼¿å·¡è¡Œ', description: 'ç¥ç”°æ˜ç¥å‘¨è¾ºã§äº¤é€šè¦åˆ¶ã‚’å®Ÿæ–½', timeRange: '10:00ã€œ18:00', area: [[35.7020, 139.7650], [35.7020, 139.7720], [35.6960, 139.7720], [35.6960, 139.7650]], center: [35.6990, 139.7685] },
            { id: 'reg3', type: 'construction', name: 'é¦–éƒ½é«˜é€Ÿ é›†ä¸­å·¥äº‹', description: 'æ¸‹è°·ç·š å¤§æ©‹JCTä»˜è¿‘ã§è»Šç·šè¦åˆ¶', timeRange: '22:00ã€œç¿Œ5:00', area: [[35.6555, 139.6875], [35.6555, 139.6930], [35.6490, 139.6930], [35.6490, 139.6875]], center: [35.6522, 139.6902] }
        ];

        const DEMO_ROAD_CONGESTION = [
            { id: 'road1', name: 'é¦–éƒ½é«˜é€Ÿ3å·æ¸‹è°·ç·š', status: 'heavy', speed: 15, normalSpeed: 60, description: 'äº‹æ•…æ¸‹æ» ç´„3km', coordinates: [[35.6459, 139.7101], [35.6350, 139.6850], [35.6280, 139.6600]] },
            { id: 'road2', name: 'å›½é“246å·', status: 'moderate', speed: 25, normalSpeed: 40, description: 'è‡ªç„¶æ¸‹æ» ç´„1.5km', coordinates: [[35.6580, 139.7016], [35.6480, 139.6750], [35.6400, 139.6500]] },
            { id: 'road3', name: 'ç’°çŠ¶ä¸ƒå·ç·š', status: 'light', speed: 35, normalSpeed: 50, description: 'ã‚„ã‚„æ··é›‘', coordinates: [[35.7200, 139.6600], [35.6800, 139.6300], [35.6400, 139.6200]] }
        ];

        // ============================================
        // State
        // ============================================

        let state = {
            useRealData: false,
            apiKey: localStorage.getItem(CONFIG.STORAGE_KEY) || '',
            trainLines: [],
            regulations: DEMO_REGULATIONS,
            roadCongestion: DEMO_ROAD_CONGESTION,
            refreshTimer: null
        };

        // ============================================
        // Map Initialization
        // ============================================

        const map = L.map('map', { center: [35.6812, 139.7671], zoom: 12, zoomControl: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const trainLayer = L.layerGroup().addTo(map);
        const regulationLayer = L.layerGroup().addTo(map);
        const roadLayer = L.layerGroup().addTo(map);

        // ============================================
        // JSON Data Loading Functions
        // ============================================

        async function loadRegulationsFromJSON() {
            try {
                const response = await fetch(CONFIG.DATA_BASE_URL + 'regulations.json');
                if (!response.ok) throw new Error('Failed to load regulations');
                const data = await response.json();
                // Filter active regulations only
                return data.regulations.filter(r => r.active);
            } catch (error) {
                console.warn('JSONã‹ã‚‰äº¤é€šè¦åˆ¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', error);
                return DEMO_REGULATIONS;
            }
        }

        async function loadRoadsFromJSON() {
            try {
                const response = await fetch(CONFIG.DATA_BASE_URL + 'roads.json');
                if (!response.ok) throw new Error('Failed to load roads');
                const data = await response.json();
                // Filter active roads only
                return data.roads.filter(r => r.active);
            } catch (error) {
                console.warn('JSONã‹ã‚‰é“è·¯æƒ…å ±ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', error);
                return DEMO_ROAD_CONGESTION;
            }
        }

        // ============================================
        // ODPT API Functions
        // ============================================

        async function fetchODPTData() {
            if (!state.apiKey) return null;

            showLoading(true);

            try {
                // Fetch Tokyo Metro train information
                const metroUrl = `${CONFIG.ODPT_API_BASE}/odpt:TrainInformation?odpt:operator=odpt.Operator:TokyoMetro&acl:consumerKey=${state.apiKey}`;
                const toeiUrl = `${CONFIG.ODPT_API_BASE}/odpt:TrainInformation?odpt:operator=odpt.Operator:Toei&acl:consumerKey=${state.apiKey}`;

                const [metroRes, toeiRes] = await Promise.all([
                    fetch(metroUrl),
                    fetch(toeiUrl)
                ]);

                if (!metroRes.ok || !toeiRes.ok) {
                    throw new Error('API request failed');
                }

                const metroData = await metroRes.json();
                const toeiData = await toeiRes.json();

                return [...metroData, ...toeiData];
            } catch (error) {
                console.error('ODPT API Error:', error);
                alert('APIã‚¨ãƒ©ãƒ¼: ' + error.message + '\nãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
                document.getElementById('useRealData').checked = false;
                state.useRealData = false;
                updateDataSourceUI();
                return null;
            } finally {
                showLoading(false);
            }
        }

        function parseODPTTrainInfo(data) {
            if (!data) return DEMO_TRAIN_LINES;

            return data.map(info => {
                const railwayId = info['odpt:railway'];
                const meta = RAILWAY_META[railwayId] || { name: railwayId, color: '#00d9ff', coords: [] };

                const statusText = info['odpt:trainInformationText'] || '';
                const isNormal = statusText.includes('å¹³å¸¸') || statusText.includes('é‹è»¢ã—ã¦ã„ã¾ã™');
                const isSuspended = statusText.includes('è¦‹åˆã‚ã›') || statusText.includes('é‹ä¼‘');
                const hasDelay = statusText.includes('é…ã‚Œ') || statusText.includes('é…å»¶');

                let status = 'normal';
                let delayMinutes = 0;

                if (isSuspended) {
                    status = 'suspended';
                    delayMinutes = null;
                } else if (hasDelay) {
                    // Extract delay minutes if mentioned
                    const match = statusText.match(/(\d+)åˆ†/);
                    delayMinutes = match ? parseInt(match[1]) : 10;
                    status = delayMinutes >= 15 ? 'delayed' : 'minor';
                }

                return {
                    id: railwayId,
                    name: meta.name,
                    color: meta.color,
                    status: status,
                    delayMinutes: delayMinutes,
                    description: statusText || 'æƒ…å ±å–å¾—ä¸­...',
                    section: null,
                    coordinates: meta.coords,
                    timestamp: info['dc:date'] || new Date().toISOString()
                };
            }).filter(line => line.coordinates.length > 0);
        }

        // ============================================
        // Rendering Functions
        // ============================================

        function getStatusColor(status) {
            switch (status) {
                case 'suspended': return '#ff3366';
                case 'delayed': return '#ff8800';
                case 'minor': return '#ffcc00';
                default: return '#00ff88';
            }
        }

        function getStatusLabel(status, delayMinutes) {
            switch (status) {
                case 'suspended': return 'é‹è»¢è¦‹åˆã‚ã›';
                case 'delayed': return `${delayMinutes}åˆ†é…å»¶`;
                case 'minor': return `${delayMinutes}åˆ†é…å»¶`;
                default: return 'å¹³å¸¸é‹è»¢';
            }
        }

        function drawTrainLines() {
            trainLayer.clearLayers();
            const lines = state.useRealData ? state.trainLines : DEMO_TRAIN_LINES;

            lines.forEach(line => {
                if (line.coordinates.length < 2) return;

                const color = getStatusColor(line.status);
                const dashArray = line.status === 'suspended' ? '10, 10' : null;
                const weight = line.status === 'suspended' || line.status === 'delayed' ? 5 : 3;

                const polyline = L.polyline(line.coordinates, {
                    color: color,
                    weight: weight,
                    opacity: 0.9,
                    dashArray: dashArray,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(trainLayer);

                const statusClass = line.status === 'suspended' ? 'status-suspended' :
                                   line.status === 'delayed' ? 'status-delayed' :
                                   line.status === 'minor' ? 'status-minor' : 'status-normal';

                polyline.bindPopup(`
                    <div class="popup-title" style="color: ${line.color}">${line.name}</div>
                    <span class="popup-status ${statusClass}">${getStatusLabel(line.status, line.delayMinutes)}</span>
                    <div class="popup-info">
                        ${line.section ? `<strong>åŒºé–“:</strong> ${line.section}<br>` : ''}
                        ${line.description}
                    </div>
                `);

                polyline._data = line;
            });
        }

        function drawRegulations() {
            regulationLayer.clearLayers();

            state.regulations.forEach(reg => {
                const polygon = L.polygon(reg.area, {
                    color: '#ff00aa',
                    weight: 2,
                    fillColor: '#ff00aa',
                    fillOpacity: 0.2,
                    dashArray: '5, 5'
                }).addTo(regulationLayer);

                const typeIcon = reg.type === 'marathon' ? 'ğŸƒ' : reg.type === 'festival' ? 'ğŸŠ' : 'ğŸ”§';

                polygon.bindPopup(`
                    <div class="popup-title">${typeIcon} ${reg.name}</div>
                    <span class="popup-status status-active">${reg.timeRange}</span>
                    <div class="popup-info">${reg.description}</div>
                `);

                const marker = L.marker(reg.center, {
                    icon: L.divIcon({
                        className: 'regulation-marker',
                        html: `<div style="background: rgba(255, 0, 170, 0.9); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 20px rgba(255, 0, 170, 0.5);">${typeIcon}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(regulationLayer);

                marker.bindPopup(polygon.getPopup());
                marker._data = reg;
            });
        }

        function drawRoads() {
            roadLayer.clearLayers();

            state.roadCongestion.forEach(road => {
                const color = road.status === 'heavy' ? '#ff3366' : road.status === 'moderate' ? '#ff8800' : '#ffcc00';

                const polyline = L.polyline(road.coordinates, {
                    color: color,
                    weight: 6,
                    opacity: 0.8,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(roadLayer);

                const statusLabel = road.status === 'heavy' ? 'æ¸‹æ»' : road.status === 'moderate' ? 'æ··é›‘' : 'ã‚„ã‚„æ··é›‘';

                polyline.bindPopup(`
                    <div class="popup-title">ğŸš— ${road.name}</div>
                    <span class="popup-status" style="background: ${color}22; color: ${color}">${statusLabel}</span>
                    <div class="popup-info">
                        <strong>ç¾åœ¨é€Ÿåº¦:</strong> ${road.speed} km/h (é€šå¸¸ ${road.normalSpeed} km/h)<br>
                        ${road.description}
                    </div>
                `);

                polyline._data = road;
            });
        }

        function createInfoCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            const lines = state.useRealData ? state.trainLines : DEMO_TRAIN_LINES;

            // Train cards
            lines.forEach(line => {
                if (line.status !== 'normal') {
                    const statusClass = line.status === 'suspended' ? 'status-suspended' :
                                       line.status === 'delayed' ? 'status-delayed' : 'status-minor';

                    const card = document.createElement('div');
                    card.className = 'info-card train';
                    card.style.setProperty('--line-color', line.color);
                    card.dataset.type = 'train';
                    card.dataset.id = line.id;

                    card.innerHTML = `
                        <div class="card-header">
                            <span class="card-title">ğŸšƒ ${line.name}</span>
                            <span class="card-status ${statusClass}">${getStatusLabel(line.status, line.delayMinutes)}</span>
                        </div>
                        <div class="card-description">${line.description}</div>
                        <div class="card-meta">
                            ${line.section ? `<span>ğŸ“ ${line.section}</span>` : ''}
                        </div>
                    `;

                    card.addEventListener('click', () => {
                        if (line.coordinates.length > 0) {
                            const bounds = L.latLngBounds(line.coordinates);
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    });

                    container.appendChild(card);
                }
            });

            // Regulation cards
            state.regulations.forEach(reg => {
                const typeIcon = reg.type === 'marathon' ? 'ğŸƒ' : reg.type === 'festival' ? 'ğŸŠ' : 'ğŸ”§';

                const card = document.createElement('div');
                card.className = 'info-card regulation';
                card.dataset.type = 'regulation';
                card.dataset.id = reg.id;

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">${typeIcon} ${reg.name}</span>
                        <span class="card-status status-active">è¦åˆ¶ä¸­</span>
                    </div>
                    <div class="card-description">${reg.description}</div>
                    <div class="card-meta">
                        <span>â° ${reg.timeRange}</span>
                    </div>
                `;

                card.addEventListener('click', () => map.setView(reg.center, 15));
                container.appendChild(card);
            });

            // Road cards
            state.roadCongestion.forEach(road => {
                const statusClass = road.status === 'heavy' ? 'status-suspended' :
                                   road.status === 'moderate' ? 'status-delayed' : 'status-minor';
                const statusLabel = road.status === 'heavy' ? 'æ¸‹æ»' :
                                   road.status === 'moderate' ? 'æ··é›‘' : 'ã‚„ã‚„æ··é›‘';

                const card = document.createElement('div');
                card.className = 'info-card road';
                card.dataset.type = 'road';
                card.dataset.id = road.id;

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">ğŸš— ${road.name}</span>
                        <span class="card-status ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="card-description">${road.description}</div>
                    <div class="card-meta">
                        <span>ğŸš¦ ${road.speed} km/h</span>
                    </div>
                `;

                card.addEventListener('click', () => {
                    const bounds = L.latLngBounds(road.coordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                });

                container.appendChild(card);
            });

            updateCounts();
        }

        function updateCounts() {
            const lines = state.useRealData ? state.trainLines : DEMO_TRAIN_LINES;
            const delayedTrains = lines.filter(l => l.status !== 'normal').length;
            const suspendedTrains = lines.filter(l => l.status === 'suspended').length;

            document.getElementById('countAll').textContent = delayedTrains + state.regulations.length + state.roadCongestion.length;
            document.getElementById('countTrain').textContent = delayedTrains;
            document.getElementById('countRegulation').textContent = state.regulations.length;
            document.getElementById('countRoad').textContent = state.roadCongestion.length;

            document.getElementById('delayedLines').textContent = delayedTrains - suspendedTrains;
            document.getElementById('suspendedLines').textContent = suspendedTrains;
            document.getElementById('activeRegulations').textContent = state.regulations.length;
            document.getElementById('congestionPoints').textContent = state.roadCongestion.length;
        }

        // ============================================
        // UI Functions
        // ============================================

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('active', show);
        }

        function updateDataSourceUI() {
            const badge = document.getElementById('liveBadge');
            const label = document.getElementById('dataSourceLabel');

            if (state.useRealData && state.apiKey) {
                badge.classList.remove('demo');
                label.textContent = 'LIVE';
            } else {
                badge.classList.add('demo');
                label.textContent = 'DEMO';
            }
        }

        function openModal() {
            document.getElementById('apiModal').classList.add('active');
            document.getElementById('apiKeyInput').value = state.apiKey;
        }

        function closeModal() {
            document.getElementById('apiModal').classList.remove('active');
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                state.apiKey = key;
                localStorage.setItem(CONFIG.STORAGE_KEY, key);
                closeModal();
                document.getElementById('useRealData').checked = true;
                state.useRealData = true;
                updateDataSourceUI();
                refreshData();
            }
        }

        async function refreshData() {
            showLoading(true);

            // Load train data
            if (state.useRealData && state.apiKey) {
                const data = await fetchODPTData();
                state.trainLines = parseODPTTrainInfo(data);
            } else {
                state.trainLines = DEMO_TRAIN_LINES;
            }

            // Load regulations and roads from JSON files
            state.regulations = await loadRegulationsFromJSON();
            state.roadCongestion = await loadRoadsFromJSON();

            showLoading(false);

            drawTrainLines();
            drawRegulations();
            drawRoads();
            createInfoCards();
        }

        // ============================================
        // Event Listeners
        // ============================================

        document.getElementById('useRealData').addEventListener('change', async (e) => {
            if (e.target.checked && !state.apiKey) {
                e.target.checked = false;
                openModal();
                return;
            }

            state.useRealData = e.target.checked;
            updateDataSourceUI();
            await refreshData();
        });

        document.getElementById('dataToggle').addEventListener('click', (e) => {
            if (e.target.tagName !== 'INPUT' && state.apiKey) return;
            if (!state.apiKey && !document.getElementById('useRealData').checked) {
                openModal();
            }
        });

        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const filter = tab.dataset.filter;
                document.querySelectorAll('.info-card').forEach(card => {
                    card.style.display = (filter === 'all' || card.dataset.type === filter) ? 'block' : 'none';
                });

                if (filter === 'all') {
                    map.addLayer(trainLayer);
                    map.addLayer(regulationLayer);
                    map.addLayer(roadLayer);
                } else if (filter === 'train') {
                    map.addLayer(trainLayer);
                    map.removeLayer(regulationLayer);
                    map.removeLayer(roadLayer);
                } else if (filter === 'regulation') {
                    map.removeLayer(trainLayer);
                    map.addLayer(regulationLayer);
                    map.removeLayer(roadLayer);
                } else if (filter === 'road') {
                    map.removeLayer(trainLayer);
                    map.removeLayer(regulationLayer);
                    map.addLayer(roadLayer);
                }
            });
        });

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        setInterval(updateClock, 1000);
        updateClock();

        // Auto-refresh
        setInterval(() => {
            if (state.useRealData) refreshData();
        }, CONFIG.REFRESH_INTERVAL);

        // ============================================
        // Initialize
        // ============================================

        (async function init() {
            if (state.apiKey) {
                document.getElementById('useRealData').checked = true;
                state.useRealData = true;
            }
            updateDataSourceUI();
            await refreshData();
        })();
    </script>
</body>
</html>
